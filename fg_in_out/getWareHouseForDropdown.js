import http from "k6/http";
import { check, sleep } from "k6";

// ‚úÖ 1Ô∏è‚É£ ‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Virtual Users ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•
export const options = {
  stages: [
    { duration: "5m", target: 500 },
    { duration: "5m", target: 1000 },
    { duration: "30s", target: 0 },
  ],
  thresholds: {
    http_req_duration: ["p(90)<700"], // ‡∏õ‡∏£‡∏±‡∏ö Response Time ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô 700ms
    "http_req_duration{status:200}": ["p(90)<600"],
    http_reqs: ["count<50000"], // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Requests ‡∏£‡∏ß‡∏°
  },
};

// ‚úÖ 2Ô∏è‚É£ ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞ Headers (Environment Variables)
const BASE_URL = "http://203.154.184.162:5012/api/warehouse/getAll";
const AUTH_TOKEN =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGl0eUlEIjoiZmExY2VjMjAtOTc0NC00ZWUzLWFhNmQtM2Y4MTcyZTEwYTcwIiwiZmlyc3RuYW1lIjoiS2lzc2FkYXBhIiwibGFzdG5hbWUiOiJOZ3VhbmNob24iLCJjb21wYW55SUQiOiIiLCJpYXQiOjE3NDA2NzM1MTAsImV4cCI6MTc0MDc1OTkxMH0.OSIfb6QOnRxADVUxVxnLU8rSfohcI_uwGie-SU6wsFA";
const X_TTT_PMRP = "ecffd46cf0f300f79f21afcac734ea9c";

// ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Dynamic Parameters)
const oem_id = "e9549a12-9b0d-4b10-b2ef-ac3607c42ab4";
const company_id = "1a947e52-07ad-44fb-baca-aa24741512c3";

// ‚úÖ 3Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Helper Functions)
function getRequestParams() {
  return {
    headers: {
      Authorization: AUTH_TOKEN,
      "X-TTT-PMRP": X_TTT_PMRP,
    },
  };
}

// ‚úÖ 4Ô∏è‚É£ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (Main Load Test Function)
export default function () {
  const url = `${BASE_URL}/${company_id}/${oem_id}`;
  const params = getRequestParams();

  // ‡∏™‡πà‡∏á Request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà API
  const response = http.get(url, params);

  // ‚úÖ 5Ô∏è‚É£ ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Validation & Logging)
  logRequest(url, response);
  validateResponse(response);

  // ‚úÖ 6Ô∏è‚É£ ‡πÉ‡∏ä‡πâ `sleep()` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ç‡∏≠‡∏á Requests
  sleep(getRandomDelay(5, 12)); // ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 5 - 12 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ Request
function logRequest(url, response) {
  console.log(`üü¢ [Request] URL: ${url}`);
  console.log(
    `üì° [Response] Status: ${response.status} | Time: ${response.timings.duration}ms`
  );

  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πà‡∏°
  if (response.status >= 500) {
    console.error(`üî• [ERROR] Server Down! Status: ${response.status}`);
  }
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
function validateResponse(response) {
  check(response, {
    "‚úÖ Status is 200": (r) => r.status === 200,
    "‚è± Response time < 700ms": (r) => r.timings.duration < 700,
  });
}

// üìå ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô: ‡∏™‡∏∏‡πà‡∏° `sleep()` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
function getRandomDelay(min, max) {
  return Math.random() * (max - min) + min;
}
